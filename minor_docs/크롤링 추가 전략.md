# ì‹ ê·œ í¬ë¡¤ëŸ¬ ì „ëµ êµ¬í˜„ í”Œëœ

> SITEMAP Â· PLATFORM_YOUTUBE Â· GRAPHQL â€” 3ê°œ ì „ëµ ì¶”ê°€ ê°€ì´ë“œ
> ì‘ì„±ì¼: 2026-02-19

---

## 1. ê³µí†µ ë³€ê²½ì‚¬í•­ (3ê°œ ì „ëµ ëª¨ë‘ ì ìš©)

ëª¨ë“  ì‹ ê·œ ì „ëµì€ ê¸°ì¡´ Strategy Patternì„ ë”°ë¥´ë©°, ì•„ë˜ 4ê°œ íŒŒì¼ì„ ê³µí†µìœ¼ë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.

### 1-1. `lib/crawlers/types.ts` â€” CrawlerType í™•ì¥

```typescript
// Before
export type CrawlerType =
  | 'AUTO' | 'STATIC' | 'SPA' | 'RSS'
  | 'PLATFORM_NAVER' | 'PLATFORM_KAKAO' | 'NEWSLETTER' | 'API';

// After
export type CrawlerType =
  | 'AUTO' | 'STATIC' | 'SPA' | 'RSS'
  | 'PLATFORM_NAVER' | 'PLATFORM_KAKAO' | 'NEWSLETTER' | 'API'
  | 'SITEMAP' | 'PLATFORM_YOUTUBE' | 'GRAPHQL';
```

### 1-2. `lib/crawlers/strategies/index.ts` â€” Factory ë“±ë¡

```typescript
import { sitemapStrategy } from './sitemap';
import { youtubeStrategy } from './youtube';
import { graphqlStrategy } from './graphql';

export function getStrategy(type: CrawlerType): CrawlStrategy {
  switch (type) {
    // ... ê¸°ì¡´ caseë“¤ ...
    case 'SITEMAP':           return sitemapStrategy;
    case 'PLATFORM_YOUTUBE':  return youtubeStrategy;
    case 'GRAPHQL':           return graphqlStrategy;
    default:                  return staticStrategy;
  }
}
```

### 1-3. `lib/crawlers/infer-type.ts` â€” URL íŒ¨í„´ ì¶”ë¡  ì¶”ê°€

```typescript
export function inferCrawlerType(url: string): { type: CrawlerType; confidence: number } {
  const u = new URL(url);

  // ... ê¸°ì¡´ íŒ¨í„´ë“¤ ...

  // SITEMAP
  if (u.pathname.includes('sitemap') && u.pathname.endsWith('.xml')) {
    return { type: 'SITEMAP', confidence: 0.95 };
  }

  // PLATFORM_YOUTUBE
  if (u.hostname.includes('youtube.com') || u.hostname === 'youtu.be') {
    return { type: 'PLATFORM_YOUTUBE', confidence: 0.95 };
  }

  // GRAPHQL â€” URLë§Œìœ¼ë¡œëŠ” ê°ì§€ ë¶ˆê°€, config.graphql_endpoint ì¡´ì¬ ì—¬ë¶€ë¡œ íŒë‹¨
  // â†’ strategy-resolver.tsì˜ AI ë‹¨ê³„ì—ì„œ ê°ì§€í•˜ê±°ë‚˜ ì‚¬ìš©ìê°€ ì§ì ‘ ì§€ì •
}
```

### 1-4. `lib/crawlers/strategy-resolver.ts` â€” ìë™ ê°ì§€ íŒŒì´í”„ë¼ì¸ í™•ì¥

8ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ì˜ Step 2~4 ì‚¬ì´ì— ì‹ ê·œ ê°ì§€ ë¡œì§ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```
ê¸°ì¡´ Step 1: HTML ë‹¤ìš´ë¡œë“œ
ê¸°ì¡´ Step 2: RSS ìë™ ë°œê²¬

ğŸ†• Step 2.5: Sitemap ìë™ ë°œê²¬
  â””â”€ <link rel="sitemap"> íƒœê·¸ íƒìƒ‰
  â””â”€ {base_url}/sitemap.xml HEAD ìš”ì²­ìœ¼ë¡œ ì¡´ì¬ í™•ì¸
  â””â”€ âœ… 200 + XML content-type â†’ SITEMAP (confidence: 0.85)

ê¸°ì¡´ Step 3: CMS ê°ì§€

ğŸ†• Step 3.5: YouTube ê°ì§€
  â””â”€ URL íŒ¨í„´: youtube.com/(@channel|channel/|c/|user/|playlist?)
  â””â”€ âœ… ë§¤ì¹­ â†’ PLATFORM_YOUTUBE (confidence: 0.95)

ê¸°ì¡´ Step 4~8: URL íŒ¨í„´, SPA, Rule-based, AI...
```

### 1-5. ì†ŒìŠ¤ ì¶”ê°€ UI ì—…ë°ì´íŠ¸

`app/sources/add/page.tsx`ì˜ í¬ë¡¤ëŸ¬ íƒ€ì… ë“œë¡­ë‹¤ìš´ì— 3ê°œ ì˜µì…˜ ì¶”ê°€:

```typescript
const CRAWLER_TYPES = [
  { value: 'AUTO', label: 'ìë™ì§€ì •' },
  // ... ê¸°ì¡´ ...
  { value: 'SITEMAP', label: 'Sitemap (XML)' },
  { value: 'PLATFORM_YOUTUBE', label: 'YouTube' },
  { value: 'GRAPHQL', label: 'GraphQL' },
];
```

---

## 2. SITEMAP ì „ëµ

> RSSê°€ ì—†ëŠ” ì‚¬ì´íŠ¸ì—ì„œ `sitemap.xml`ì„ íŒŒì‹±í•´ ì‹ ê·œ ì½˜í…ì¸  URLì„ ë°œê²¬í•˜ëŠ” ì „ëµ

### 2-1. í•µì‹¬ ì•„ì´ë””ì–´

Sitemapì€ ê²€ìƒ‰ì—”ì§„ì„ ìœ„í•´ ëŒ€ë¶€ë¶„ì˜ ì‚¬ì´íŠ¸ê°€ ì œê³µí•˜ëŠ” XML íŒŒì¼ì…ë‹ˆë‹¤.
RSSê°€ ì—†ì–´ë„ `sitemap.xml`ì—ì„œ URL + `lastmod` ë‚ ì§œë¥¼ ì¶”ì¶œí•˜ë©´ ì‹ ê·œ ì½˜í…ì¸ ë¥¼ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
sitemap.xml íŒŒì‹± â†’ URL + lastmod ì¶”ì¶œ â†’ ìµœê·¼ Nì¼ í•„í„°ë§
â†’ ê° URLì—ì„œ ë³¸ë¬¸ ì¶”ì¶œ (content-extractor.ts ì¬ì‚¬ìš©)
â†’ RawContentItem[] ë°˜í™˜
```

### 2-2. íŒŒì¼: `lib/crawlers/strategies/sitemap.ts`

```typescript
import * as cheerio from 'cheerio';
import type { CrawlStrategy, CrawlSource, RawContentItem } from '../types';
import { extractContent } from '../content-extractor';
import { isWithinDays } from '../base';

export const sitemapStrategy: CrawlStrategy = {
  type: 'SITEMAP',

  async crawlList(source: CrawlSource): Promise<RawContentItem[]> {
    const config = source.config || {};
    const maxPages = config.pagination?.maxPages || 100; // URL ìµœëŒ€ ê°œìˆ˜
    const withinDays = config.crawl_config?.withinDays || 7;

    // 1. Sitemap URL ê²°ì •
    const sitemapUrl = resolveSitemapUrl(source.base_url, config);

    // 2. Sitemap XML ë‹¤ìš´ë¡œë“œ
    const response = await fetchWithTimeout(sitemapUrl, DEFAULT_HEADERS, 15000);
    const xml = await response.text();
    const $ = cheerio.load(xml, { xmlMode: true });

    // 3. Sitemap Index ì²˜ë¦¬ (ì¤‘ì²© sitemap ì§€ì›)
    const sitemapIndexUrls = $('sitemapindex > sitemap > loc')
      .map((_, el) => $(el).text().trim())
      .get();

    let urls: SitemapEntry[] = [];

    if (sitemapIndexUrls.length > 0) {
      // Sitemap Index â†’ ê°œë³„ sitemap ìˆœíšŒ (ìµœëŒ€ 3ê°œ)
      for (const subUrl of sitemapIndexUrls.slice(0, 3)) {
        const subEntries = await parseSitemapXml(subUrl);
        urls.push(...subEntries);
      }
    } else {
      // ë‹¨ì¼ Sitemap
      urls = parseSitemapEntries($);
    }

    // 4. ìµœê·¼ Nì¼ í•„í„°ë§ + ì •ë ¬
    const filtered = urls
      .filter(entry => {
        if (!entry.lastmod) return true; // lastmod ì—†ìœ¼ë©´ í¬í•¨ (ë³¸ë¬¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ)
        return isWithinDays(entry.lastmod, withinDays);
      })
      .sort((a, b) => {
        // lastmod ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹  ìš°ì„ )
        if (!a.lastmod) return 1;
        if (!b.lastmod) return -1;
        return new Date(b.lastmod).getTime() - new Date(a.lastmod).getTime();
      })
      .slice(0, maxPages);

    // 5. ê° URLì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (title, content_preview)
    //    â†’ ê°œë³„ í˜ì´ì§€ fetchëŠ” crawlContentì—ì„œ ì²˜ë¦¬
    const items: RawContentItem[] = filtered.map(entry => ({
      title: '',           // ë³¸ë¬¸ ì¶”ì¶œ ì‹œ <title> íƒœê·¸ì—ì„œ ì±„ì›€
      link: entry.loc,
      dateStr: entry.lastmod || '',
      thumbnail: '',
    }));

    return items;
  },

  async crawlContent(url: string, config?: any): Promise<string> {
    // ê¸°ì¡´ content-extractor.ts ì¬ì‚¬ìš©
    return extractContent(url, config);
  },
};
```

### 2-3. Sitemap íŒŒì‹± ìœ í‹¸

```typescript
interface SitemapEntry {
  loc: string;
  lastmod?: string;
  changefreq?: string;
  priority?: string;
}

function parseSitemapEntries($: cheerio.CheerioAPI): SitemapEntry[] {
  return $('urlset > url').map((_, el) => ({
    loc: $(el).find('loc').text().trim(),
    lastmod: $(el).find('lastmod').text().trim() || undefined,
    changefreq: $(el).find('changefreq').text().trim() || undefined,
    priority: $(el).find('priority').text().trim() || undefined,
  })).get();
}

function resolveSitemapUrl(baseUrl: string, config: any): string {
  // 1. configì— ëª…ì‹œì  sitemap URLì´ ìˆìœ¼ë©´ ì‚¬ìš©
  if (config.sitemap_url) return config.sitemap_url;

  // 2. base_urlì´ ì´ë¯¸ sitemap.xmlì´ë©´ ê·¸ëŒ€ë¡œ
  if (baseUrl.includes('sitemap') && baseUrl.endsWith('.xml')) return baseUrl;

  // 3. ê¸°ë³¸: {origin}/sitemap.xml
  const u = new URL(baseUrl);
  return `${u.origin}/sitemap.xml`;
}
```

### 2-4. Config êµ¬ì¡°

```json
{
  "sitemap_url": "https://example.com/post-sitemap.xml",
  "crawl_config": {
    "withinDays": 7,
    "delay": 1000
  },
  "pagination": {
    "maxPages": 100
  },
  "content_selectors": {
    "content": "article.post-content",
    "removeSelectors": [".ad", ".sidebar"]
  },
  "url_filters": {
    "include": ["/blog/", "/posts/"],
    "exclude": ["/tag/", "/category/", "/page/"]
  }
}
```

### 2-5. í•µì‹¬ ê³ ë ¤ì‚¬í•­

| í•­ëª© | ì„¤ëª… |
|------|------|
| Sitemap Index | ëŒ€í˜• ì‚¬ì´íŠ¸ëŠ” `sitemapindex`ë¡œ ì—¬ëŸ¬ sitemapì„ ë¬¶ìŒ. ìµœëŒ€ 3ê°œë§Œ ìˆœíšŒ |
| URL í•„í„°ë§ | `url_filters.include/exclude`ë¡œ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë§Œ ì„ ë³„ (íƒœê·¸/ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ ì œì™¸) |
| lastmod ì—†ëŠ” ê²½ìš° | ì¼ë¶€ ì‚¬ì´íŠ¸ëŠ” lastmodë¥¼ ì œê³µí•˜ì§€ ì•ŠìŒ â†’ ë³¸ë¬¸ í˜ì´ì§€ì˜ ë‚ ì§œë¥¼ date-parser.tsë¡œ ì¶”ì¶œ |
| title ì¶”ì¶œ | sitemapì—ëŠ” titleì´ ì—†ìŒ â†’ crawlContent ë‹¨ê³„ì—ì„œ `<title>` íƒœê·¸ ë˜ëŠ” `<h1>` ì¶”ì¶œ |
| ëŒ€ëŸ‰ URL | sitemapì— ìˆ˜ì²œ ê°œ URLì´ ìˆì„ ìˆ˜ ìˆìŒ â†’ maxPagesë¡œ ì œí•œ (ê¸°ë³¸ 100) |
| ì¤‘ë³µ ë°©ì§€ | ê¸°ì¡´ source_id í•´ì‹œ ê¸°ë°˜ ì¤‘ë³µ ì²´í¬ê°€ ê·¸ëŒ€ë¡œ ì‘ë™ |

### 2-6. ìë™ ê°ì§€ í†µí•©

`strategy-resolver.ts`ì—ì„œ RSS ë°œê²¬ ì‹¤íŒ¨ í›„ Sitemap íƒìƒ‰ ì¶”ê°€:

```typescript
// Step 2.5: Sitemap ìë™ ë°œê²¬
async function discoverSitemap(baseUrl: string): Promise<string | null> {
  const candidates = [
    `${origin}/sitemap.xml`,
    `${origin}/sitemap_index.xml`,
    `${origin}/post-sitemap.xml`,
  ];

  for (const url of candidates) {
    try {
      const res = await fetchWithTimeout(url, {}, 5000);
      const contentType = res.headers.get('content-type') || '';
      if (res.ok && (contentType.includes('xml') || contentType.includes('text'))) {
        const text = await res.text();
        if (text.includes('<urlset') || text.includes('<sitemapindex')) {
          return url;
        }
      }
    } catch { /* skip */ }
  }

  // HTML ë‚´ sitemap ë§í¬ íƒìƒ‰
  // <link rel="sitemap" href="...">
  return null;
}
```

---

## 3. PLATFORM_YOUTUBE ì „ëµ

> YouTube ì±„ë„/ì¬ìƒëª©ë¡ì˜ ì˜ìƒì„ YouTube Data API v3ë¡œ í¬ë¡¤ë§

### 3-1. í•µì‹¬ ì•„ì´ë””ì–´

```
YouTube URL íŒŒì‹± â†’ ì±„ë„ID/ì¬ìƒëª©ë¡ID ì¶”ì¶œ
â†’ YouTube Data API v3 í˜¸ì¶œ (search.list ë˜ëŠ” playlistItems.list)
â†’ ì˜ìƒ ë©”íƒ€ë°ì´í„° (title, thumbnail, publishedAt, description) ë§¤í•‘
â†’ RawContentItem[] ë°˜í™˜
```

### 3-2. í™˜ê²½ë³€ìˆ˜ ì¶”ê°€

```env
# .env.local
YOUTUBE_API_KEY=AIza...  # YouTube Data API v3 í‚¤ (Google Cloud Consoleì—ì„œ ë°œê¸‰)
```

**ë¹„ìš©**: ë¬´ë£Œ ì¼ì¼ ì¿¼í„° 10,000 ìœ ë‹›. `search.list`ëŠ” 100 ìœ ë‹›/ìš”ì²­, `playlistItems.list`ëŠ” 1 ìœ ë‹›/ìš”ì²­.
â†’ ì±„ë„ì˜ "Uploads" ì¬ìƒëª©ë¡ì„ ì‚¬ìš©í•˜ë©´ 1 ìœ ë‹›ìœ¼ë¡œ ìµœëŒ€ 50ê°œ ì˜ìƒ ì¡°íšŒ ê°€ëŠ¥.

### 3-3. íŒŒì¼: `lib/crawlers/strategies/youtube.ts`

```typescript
import type { CrawlStrategy, CrawlSource, RawContentItem } from '../types';

const YOUTUBE_API_BASE = 'https://www.googleapis.com/youtube/v3';

export const youtubeStrategy: CrawlStrategy = {
  type: 'PLATFORM_YOUTUBE',

  async crawlList(source: CrawlSource): Promise<RawContentItem[]> {
    const apiKey = process.env.YOUTUBE_API_KEY;
    if (!apiKey) throw new Error('YOUTUBE_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');

    const config = source.config || {};
    const maxResults = config.crawl_config?.maxResults || 20;

    // 1. URLì—ì„œ ì±„ë„/ì¬ìƒëª©ë¡ ì •ë³´ ì¶”ì¶œ
    const parsed = parseYouTubeUrl(source.base_url);

    let items: YouTubeVideoItem[];

    if (parsed.type === 'playlist') {
      // ì¬ìƒëª©ë¡ â†’ playlistItems.list (1 ìœ ë‹›/ìš”ì²­, íš¨ìœ¨ì )
      items = await fetchPlaylistItems(apiKey, parsed.id, maxResults);
    } else if (parsed.type === 'channel') {
      // ì±„ë„ â†’ ë¨¼ì € Uploads ì¬ìƒëª©ë¡ ID ì¡°íšŒ â†’ playlistItems.list
      const uploadsPlaylistId = await getUploadsPlaylistId(apiKey, parsed.id);
      items = await fetchPlaylistItems(apiKey, uploadsPlaylistId, maxResults);
    } else if (parsed.type === 'handle') {
      // @handle â†’ channels.listë¡œ ì±„ë„ ID ì¡°íšŒ â†’ Uploads ì¬ìƒëª©ë¡
      const channelId = await resolveHandle(apiKey, parsed.id);
      const uploadsPlaylistId = await getUploadsPlaylistId(apiKey, channelId);
      items = await fetchPlaylistItems(apiKey, uploadsPlaylistId, maxResults);
    } else {
      throw new Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” YouTube URL í˜•ì‹: ${source.base_url}`);
    }

    // 2. RawContentItemìœ¼ë¡œ ë§¤í•‘
    return items.map(item => ({
      title: item.title,
      link: `https://www.youtube.com/watch?v=${item.videoId}`,
      dateStr: item.publishedAt,
      thumbnail: item.thumbnail,
      author: item.channelTitle,
      // content_previewëŠ” ì˜ìƒ ì„¤ëª…(description)ìœ¼ë¡œ ì±„ì›€
      content: item.description?.slice(0, 500) || '',
    }));
  },

  // YouTube ì˜ìƒì€ ë³„ë„ ë³¸ë¬¸ ì¶”ì¶œ ë¶ˆí•„ìš” (descriptionì´ ë³¸ë¬¸)
  async crawlContent(url: string): Promise<string> {
    const apiKey = process.env.YOUTUBE_API_KEY;
    if (!apiKey) return '';

    const videoId = extractVideoId(url);
    if (!videoId) return '';

    const res = await fetch(
      `${YOUTUBE_API_BASE}/videos?part=snippet&id=${videoId}&key=${apiKey}`
    );
    const data = await res.json();
    return data.items?.[0]?.snippet?.description || '';
  },
};
```

### 3-4. YouTube URL íŒŒì„œ

```typescript
interface ParsedYouTubeUrl {
  type: 'channel' | 'handle' | 'playlist' | 'unknown';
  id: string;
}

function parseYouTubeUrl(url: string): ParsedYouTubeUrl {
  const u = new URL(url);

  // https://youtube.com/@handle
  const handleMatch = u.pathname.match(/^\/@([^\/]+)/);
  if (handleMatch) return { type: 'handle', id: handleMatch[1] };

  // https://youtube.com/channel/UCxxxx
  const channelMatch = u.pathname.match(/^\/channel\/(UC[^\/]+)/);
  if (channelMatch) return { type: 'channel', id: channelMatch[1] };

  // https://youtube.com/c/ChannelName ë˜ëŠ” /user/Username
  const legacyMatch = u.pathname.match(/^\/(c|user)\/([^\/]+)/);
  if (legacyMatch) return { type: 'handle', id: legacyMatch[2] };

  // https://youtube.com/playlist?list=PLxxxx
  const playlistId = u.searchParams.get('list');
  if (playlistId) return { type: 'playlist', id: playlistId };

  return { type: 'unknown', id: '' };
}
```

### 3-5. API í˜¸ì¶œ í•¨ìˆ˜

```typescript
interface YouTubeVideoItem {
  videoId: string;
  title: string;
  description: string;
  publishedAt: string;
  thumbnail: string;
  channelTitle: string;
}

// ì±„ë„ IDë¡œ Uploads ì¬ìƒëª©ë¡ ID ì¡°íšŒ (2 ìœ ë‹›)
async function getUploadsPlaylistId(apiKey: string, channelId: string): Promise<string> {
  const res = await fetch(
    `${YOUTUBE_API_BASE}/channels?part=contentDetails&id=${channelId}&key=${apiKey}`
  );
  const data = await res.json();
  const uploads = data.items?.[0]?.contentDetails?.relatedPlaylists?.uploads;
  if (!uploads) throw new Error(`ì±„ë„ ${channelId}ì˜ Uploads ì¬ìƒëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
  return uploads; // "UU" + channelId.slice(2)
}

// @handle â†’ ì±„ë„ ID ë³€í™˜ (5 ìœ ë‹›)
async function resolveHandle(apiKey: string, handle: string): Promise<string> {
  const res = await fetch(
    `${YOUTUBE_API_BASE}/channels?part=id&forHandle=${handle}&key=${apiKey}`
  );
  const data = await res.json();
  const channelId = data.items?.[0]?.id;
  if (!channelId) throw new Error(`@${handle} ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
  return channelId;
}

// ì¬ìƒëª©ë¡ ì˜ìƒ ëª©ë¡ ì¡°íšŒ (1 ìœ ë‹›/ìš”ì²­, ìµœëŒ€ 50ê°œ/ìš”ì²­)
async function fetchPlaylistItems(
  apiKey: string,
  playlistId: string,
  maxResults: number
): Promise<YouTubeVideoItem[]> {
  const items: YouTubeVideoItem[] = [];
  let pageToken = '';

  while (items.length < maxResults) {
    const limit = Math.min(50, maxResults - items.length);
    const url = `${YOUTUBE_API_BASE}/playlistItems?part=snippet` +
      `&playlistId=${playlistId}&maxResults=${limit}&key=${apiKey}` +
      (pageToken ? `&pageToken=${pageToken}` : '');

    const res = await fetch(url);
    if (!res.ok) throw new Error(`YouTube API ì˜¤ë¥˜: ${res.status}`);

    const data = await res.json();

    for (const item of data.items || []) {
      const snippet = item.snippet;
      items.push({
        videoId: snippet.resourceId.videoId,
        title: snippet.title,
        description: snippet.description,
        publishedAt: snippet.publishedAt,
        thumbnail: snippet.thumbnails?.medium?.url
          || snippet.thumbnails?.default?.url || '',
        channelTitle: snippet.channelTitle,
      });
    }

    pageToken = data.nextPageToken;
    if (!pageToken) break;
  }

  return items;
}
```

### 3-6. Config êµ¬ì¡°

```json
{
  "crawl_config": {
    "maxResults": 20,
    "withinDays": 30
  }
}
```

YouTubeëŠ” ì…€ë ‰í„°ê°€ í•„ìš” ì—†ê³  API ê¸°ë°˜ì´ë¯€ë¡œ configê°€ ê°„ë‹¨í•©ë‹ˆë‹¤.

### 3-7. API ì¿¼í„° ìµœì í™”

| API í˜¸ì¶œ | ìœ ë‹› | ë¹ˆë„ |
|----------|------|------|
| `channels.list` (ì±„ë„ ì¡°íšŒ) | 2 | ì†ŒìŠ¤ë‹¹ 1íšŒ |
| `channels.list` (í•¸ë“¤ ë³€í™˜) | 5 | ì†ŒìŠ¤ë‹¹ 1íšŒ |
| `playlistItems.list` (ì˜ìƒ ëª©ë¡) | 1 | í¬ë¡¤ë§ë§ˆë‹¤ 1íšŒ |
| `videos.list` (ì˜ìƒ ìƒì„¸) | 1 | ë³¸ë¬¸ ì¶”ì¶œ ì‹œ |

**ì¼ì¼ í¬ë¡¤ë§ ì˜ˆìƒ** (YouTube ì†ŒìŠ¤ 10ê°œ ê¸°ì¤€):
- ì±„ë„ ì¡°íšŒ: 10 Ã— 2 = 20 ìœ ë‹›
- ì˜ìƒ ëª©ë¡: 10 Ã— 1 = 10 ìœ ë‹›
- í•©ê³„: ~30 ìœ ë‹›/ì¼ (ì¼ì¼ í•œë„ 10,000ì˜ 0.3%)

**ì¶”ê°€ ìµœì í™”**: ì†ŒìŠ¤ ì €ì¥ ì‹œ ì±„ë„ IDì™€ Uploads ì¬ìƒëª©ë¡ IDë¥¼ `config`ì— ìºì‹œí•˜ë©´
ë§¤ í¬ë¡¤ë§ë§ˆë‹¤ ì±„ë„ ì¡°íšŒ APIë¥¼ ìƒëµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```json
{
  "_youtube": {
    "channelId": "UCxxxx",
    "uploadsPlaylistId": "UUxxxx"
  }
}
```

### 3-8. ì´ë¯¸ì§€ í”„ë¡ì‹œ ì—…ë°ì´íŠ¸

YouTube ì¸ë„¤ì¼ ë„ë©”ì¸ì„ `image-proxy`ì˜ ALLOWED_DOMAINSì— ì¶”ê°€:

```typescript
// app/api/image-proxy/route.ts
const ALLOWED_DOMAINS = [
  // ... ê¸°ì¡´ ë„ë©”ì¸ë“¤ ...
  'i.ytimg.com',
  'img.youtube.com',
];
```

---

## 4. GRAPHQL ì „ëµ

> configì— query/endpoint/mappingì„ ììœ ë¡­ê²Œ ì„¤ì •í•˜ëŠ” ë²”ìš© GraphQL í¬ë¡¤ëŸ¬

### 4-1. í•µì‹¬ ì•„ì´ë””ì–´

GraphQL APIë¥¼ ì œê³µí•˜ëŠ” ì‚¬ì´íŠ¸(Velog, Hashnode ë“±)ì—ì„œ ë‹¨ì¼ ì¿¼ë¦¬ë¡œ
ì•„í‹°í´ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë²”ìš© ì „ëµì…ë‹ˆë‹¤. ê¸°ì¡´ `API` ì „ëµ(REST)ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ
POST + JSON body + ì‘ë‹µ ë§¤í•‘ì´ ë‹¤ë¦…ë‹ˆë‹¤.

```
configì—ì„œ endpoint + query + variables + field_mapping ì½ê¸°
â†’ POST GraphQL ìš”ì²­
â†’ ì‘ë‹µ JSONì„ field_mappingìœ¼ë¡œ RawContentItem[]ì— ë§¤í•‘
â†’ ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜ ìë™ ì²˜ë¦¬
```

### 4-2. íŒŒì¼: `lib/crawlers/strategies/graphql.ts`

```typescript
import type { CrawlStrategy, CrawlSource, RawContentItem } from '../types';
import { extractContent } from '../content-extractor';
import { isWithinDays } from '../base';

export const graphqlStrategy: CrawlStrategy = {
  type: 'GRAPHQL',

  async crawlList(source: CrawlSource): Promise<RawContentItem[]> {
    const config = source.config || {};
    const {
      graphql_endpoint,
      graphql_query,
      graphql_variables = {},
      field_mapping,
      pagination: paginationConfig,
    } = config;

    if (!graphql_endpoint || !graphql_query || !field_mapping) {
      throw new Error('GRAPHQL ì „ëµì—ëŠ” graphql_endpoint, graphql_query, field_mappingì´ í•„ìˆ˜ì…ë‹ˆë‹¤');
    }

    const allItems: RawContentItem[] = [];
    const maxPages = paginationConfig?.maxPages || 3;
    let cursor: string | null = null;

    for (let page = 0; page < maxPages; page++) {
      // 1. Variablesì— ì»¤ì„œ/í˜ì´ì§€ ì£¼ì…
      const variables = {
        ...graphql_variables,
        ...(cursor && paginationConfig?.cursor_variable
          ? { [paginationConfig.cursor_variable]: cursor }
          : {}),
      };

      // 2. GraphQL ìš”ì²­
      const response = await fetch(graphql_endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(config.headers || {}),
        },
        body: JSON.stringify({ query: graphql_query, variables }),
      });

      if (!response.ok) {
        throw new Error(`GraphQL ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
      }

      const json = await response.json();

      if (json.errors?.length) {
        throw new Error(`GraphQL ì—ëŸ¬: ${json.errors[0].message}`);
      }

      // 3. ì‘ë‹µì—ì„œ ì•„ì´í…œ ë°°ì—´ ì¶”ì¶œ (dot notation path)
      const items = getNestedValue(json.data, field_mapping.items_path);
      if (!Array.isArray(items) || items.length === 0) break;

      // 4. field_mappingìœ¼ë¡œ RawContentItem ë§¤í•‘
      for (const item of items) {
        allItems.push({
          title: getNestedValue(item, field_mapping.title) || '',
          link: resolveLink(getNestedValue(item, field_mapping.link), source.base_url),
          dateStr: getNestedValue(item, field_mapping.date) || '',
          thumbnail: getNestedValue(item, field_mapping.thumbnail) || '',
          author: getNestedValue(item, field_mapping.author) || '',
          content: getNestedValue(item, field_mapping.content) || '',
        });
      }

      // 5. ë‹¤ìŒ í˜ì´ì§€ ì»¤ì„œ ì¶”ì¶œ
      if (paginationConfig?.cursor_path) {
        cursor = getNestedValue(json.data, paginationConfig.cursor_path);
        if (!cursor) break;
      } else {
        break; // í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì • ì—†ìœ¼ë©´ 1í˜ì´ì§€ë§Œ
      }
    }

    return allItems;
  },

  async crawlContent(url: string, config?: any): Promise<string> {
    // GraphQL APIì—ì„œ ë³¸ë¬¸ì„ ì´ë¯¸ ê°€ì ¸ì™”ìœ¼ë©´ skip
    // ì•„ë‹ˆë©´ ê¸°ì¡´ content-extractor ì‚¬ìš©
    return extractContent(url, config);
  },
};
```

### 4-3. ìœ í‹¸ í•¨ìˆ˜

```typescript
/**
 * dot notationìœ¼ë¡œ ì¤‘ì²© ê°ì²´ì—ì„œ ê°’ ì¶”ì¶œ
 * ì˜ˆ: getNestedValue(obj, "data.posts.edges") â†’ obj.data.posts.edges
 */
function getNestedValue(obj: any, path: string): any {
  if (!path) return undefined;
  return path.split('.').reduce((acc, key) => acc?.[key], obj);
}

/**
 * ìƒëŒ€ URLì„ ì ˆëŒ€ URLë¡œ ë³€í™˜
 */
function resolveLink(link: string, baseUrl: string): string {
  if (!link) return '';
  if (link.startsWith('http')) return link;
  try {
    return new URL(link, baseUrl).toString();
  } catch {
    return link;
  }
}
```

### 4-4. Config êµ¬ì¡° (ë²”ìš©)

```json
{
  "graphql_endpoint": "https://v2.velog.io/graphql",
  "graphql_query": "query ($username: String!, $cursor: ID) { posts(username: $username, cursor: $cursor) { id title url_slug released_at thumbnail short_description user { username } } }",
  "graphql_variables": {
    "username": "velopert"
  },
  "field_mapping": {
    "items_path": "posts",
    "title": "title",
    "link": "url_slug",
    "date": "released_at",
    "thumbnail": "thumbnail",
    "author": "user.username",
    "content": "short_description"
  },
  "pagination": {
    "cursor_variable": "cursor",
    "cursor_path": "posts.-1.id",
    "maxPages": 3
  },
  "link_template": "https://velog.io/@{author}/{link}",
  "headers": {},
  "crawl_config": {
    "delay": 500
  }
}
```

### 4-5. í”Œë«í¼ë³„ Config í”„ë¦¬ì…‹

ì‚¬ìš©ì í¸ì˜ë¥¼ ìœ„í•´ ì•Œë ¤ì§„ GraphQL í”Œë«í¼ì˜ í”„ë¦¬ì…‹ì„ ì œê³µí•©ë‹ˆë‹¤.

#### Velog í”„ë¦¬ì…‹

```json
{
  "graphql_endpoint": "https://v2.velog.io/graphql",
  "graphql_query": "query Posts($username: String!, $cursor: ID) { posts(username: $username, cursor: $cursor) { id title url_slug released_at thumbnail short_description user { username } } }",
  "graphql_variables": { "username": "{USERNAME}" },
  "field_mapping": {
    "items_path": "posts",
    "title": "title",
    "link": "url_slug",
    "date": "released_at",
    "thumbnail": "thumbnail",
    "author": "user.username",
    "content": "short_description"
  },
  "link_template": "https://velog.io/@{variables.username}/{link}",
  "pagination": {
    "cursor_variable": "cursor",
    "cursor_path": "posts.-1.id",
    "maxPages": 3
  }
}
```

#### Hashnode í”„ë¦¬ì…‹

```json
{
  "graphql_endpoint": "https://gql.hashnode.com",
  "graphql_query": "query ($host: String!, $first: Int!, $after: String) { publication(host: $host) { posts(first: $first, after: $after) { edges { node { id title url brief publishedAt coverImage { url } author { name } } } pageInfo { endCursor hasNextPage } } } }",
  "graphql_variables": { "host": "{BLOG_HOST}", "first": 20 },
  "field_mapping": {
    "items_path": "publication.posts.edges",
    "title": "node.title",
    "link": "node.url",
    "date": "node.publishedAt",
    "thumbnail": "node.coverImage.url",
    "author": "node.author.name",
    "content": "node.brief"
  },
  "pagination": {
    "cursor_variable": "after",
    "cursor_path": "publication.posts.pageInfo.endCursor",
    "maxPages": 3
  }
}
```

### 4-6. link_template ì²˜ë¦¬

GraphQL ì‘ë‹µì—ì„œ ë°›ì€ `link`ê°€ slug í˜•íƒœì¼ ë•Œ ì „ì²´ URLë¡œ ë³€í™˜í•˜ëŠ” í…œí”Œë¦¿:

```typescript
function resolveLink(rawLink: string, baseUrl: string, config: any): string {
  const template = config.link_template;

  if (!template) {
    // í…œí”Œë¦¿ ì—†ìœ¼ë©´ ê¸°ë³¸ URL ê²°í•©
    if (rawLink.startsWith('http')) return rawLink;
    return new URL(rawLink, baseUrl).toString();
  }

  // í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜
  // "https://velog.io/@{variables.username}/{link}"
  let resolved = template.replace('{link}', rawLink);

  // {variables.xxx} ì¹˜í™˜
  resolved = resolved.replace(/\{variables\.(\w+)\}/g, (_, key) => {
    return config.graphql_variables?.[key] || '';
  });

  // {author} ë“± ì•„ì´í…œ í•„ë“œ ì¹˜í™˜
  // â†’ crawlListì—ì„œ ë§¤í•‘ í›„ ì²˜ë¦¬

  return resolved;
}
```

### 4-7. ìë™ ê°ì§€ í•œê³„

GraphQLì€ URLë§Œìœ¼ë¡œ ê°ì§€ê°€ ì–´ë µìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì•„ë˜ ê²½ìš°ëŠ” ìë™ ê°ì§€ ê°€ëŠ¥:

```typescript
// strategy-resolver.ts AI ë‹¨ê³„ì—ì„œ íŒíŠ¸ ì œê³µ
// Step 7 AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€:
`
8ë²ˆì§¸ í¬ë¡¤ëŸ¬ íƒ€ì… GRAPHQL:
- GraphQL APIë¥¼ ì œê³µí•˜ëŠ” í”Œë«í¼ (Velog, Hashnode ë“±)
- í˜ì´ì§€ ì†ŒìŠ¤ì— 'graphql', '__NEXT_DATA__'ì— GraphQL ì¿¼ë¦¬ê°€ í¬í•¨
- ì¼ë°˜ì ì¸ HTML í¬ë¡¤ë§ë³´ë‹¤ API í˜¸ì¶œì´ ë” ì•ˆì •ì ì¸ ê²½ìš°
`
```

**ì‹¤ì§ˆì ìœ¼ë¡œëŠ” ì‚¬ìš©ìê°€ ì†ŒìŠ¤ ì¶”ê°€ ì‹œ ì§ì ‘ GRAPHQLì„ ì„ íƒí•˜ê³  configë¥¼ ì…ë ¥í•˜ëŠ” ë°©ì‹ì´ ì£¼ê°€ ë©ë‹ˆë‹¤.**

---

## 5. êµ¬í˜„ ìˆœì„œ ë° ìš°ì„ ìˆœìœ„

### Phase 1: ê¸°ë°˜ ì‘ì—… (ê³µí†µ)

| ìˆœì„œ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| 1 | `types.ts`ì— 3ê°œ íƒ€ì… ì¶”ê°€ | 5ë¶„ |
| 2 | `strategies/index.ts` Factoryì— 3ê°œ ë“±ë¡ | 5ë¶„ |
| 3 | `infer-type.ts` URL íŒ¨í„´ ì¶”ê°€ (SITEMAP, YOUTUBE) | 15ë¶„ |
| 4 | ì†ŒìŠ¤ ì¶”ê°€ UI ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ | 10ë¶„ |

### Phase 2: SITEMAP êµ¬í˜„

| ìˆœì„œ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| 1 | `strategies/sitemap.ts` ì‘ì„± | 1ì‹œê°„ |
| 2 | Sitemap Index(ì¤‘ì²©) ì²˜ë¦¬ | 30ë¶„ |
| 3 | URL í•„í„°ë§ (include/exclude) | 20ë¶„ |
| 4 | `strategy-resolver.ts` Sitemap ìë™ ë°œê²¬ ì¶”ê°€ | 30ë¶„ |
| 5 | í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ì‚¬ì´íŠ¸ 3ê°œ) | 30ë¶„ |

### Phase 3: PLATFORM_YOUTUBE êµ¬í˜„

| ìˆœì„œ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| 1 | YouTube API í‚¤ ë°œê¸‰ + í™˜ê²½ë³€ìˆ˜ ì„¤ì • | 15ë¶„ |
| 2 | `strategies/youtube.ts` ì‘ì„± | 1ì‹œê°„ |
| 3 | URL íŒŒì„œ (ì±„ë„/@handle/ì¬ìƒëª©ë¡) | 30ë¶„ |
| 4 | ì´ë¯¸ì§€ í”„ë¡ì‹œ ë„ë©”ì¸ ì¶”ê°€ | 5ë¶„ |
| 5 | `strategy-resolver.ts` YouTube ê°ì§€ ì¶”ê°€ | 15ë¶„ |
| 6 | ì±„ë„ ID/ì¬ìƒëª©ë¡ ID ìºì‹± ë¡œì§ | 20ë¶„ |
| 7 | í…ŒìŠ¤íŠ¸ (ì±„ë„ 2ê°œ + ì¬ìƒëª©ë¡ 1ê°œ) | 20ë¶„ |

### Phase 4: GRAPHQL êµ¬í˜„

| ìˆœì„œ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| 1 | `strategies/graphql.ts` ì‘ì„± | 1ì‹œê°„ |
| 2 | dot notation ìœ í‹¸ + link_template ì²˜ë¦¬ | 30ë¶„ |
| 3 | ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜ | 30ë¶„ |
| 4 | Velog í”„ë¦¬ì…‹ ì‘ì„± + í…ŒìŠ¤íŠ¸ | 30ë¶„ |
| 5 | Hashnode í”„ë¦¬ì…‹ ì‘ì„± + í…ŒìŠ¤íŠ¸ | 30ë¶„ |
| 6 | AI í”„ë¡¬í”„íŠ¸ì— GRAPHQL íƒ€ì… ì„¤ëª… ì¶”ê°€ | 15ë¶„ |
| 7 | ì†ŒìŠ¤ ì¶”ê°€ UIì— í”„ë¦¬ì…‹ ì„ íƒ ê¸°ëŠ¥ | 30ë¶„ |

### Phase 5: Edge Function ì—…ë°ì´íŠ¸

| ìˆœì„œ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| 1 | `detect-crawler-type` AI í”„ë¡¬í”„íŠ¸ì— 3ê°œ íƒ€ì… ì¶”ê°€ | 15ë¶„ |
| 2 | Edge Function ì¬ë°°í¬ | 5ë¶„ |

---

## 6. í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

```bash
# SITEMAP
npx tsx scripts/crawl.ts --source=<sitemap_source_id> --verbose --dry

# PLATFORM_YOUTUBE
npx tsx scripts/crawl.ts --source=<youtube_source_id> --verbose --dry

# GRAPHQL
npx tsx scripts/crawl.ts --source=<graphql_source_id> --verbose --dry
```

### ê²€ì¦ í•­ëª©

| í•­ëª© | SITEMAP | YOUTUBE | GRAPHQL |
|------|---------|---------|---------|
| ì•„í‹°í´ ë°œê²¬ (found > 0) | âœ… | âœ… | âœ… |
| ì¤‘ë³µ ì²´í¬ (source_id í•´ì‹œ) | âœ… | âœ… | âœ… |
| ë‚ ì§œ í•„í„°ë§ (7ì¼/30ì¼) | âœ… | âœ… | âœ… |
| ë³¸ë¬¸ ì¶”ì¶œ (content_preview) | âœ… | âœ… (description) | âœ… |
| ì¸ë„¤ì¼ | âœ… (OG íƒœê·¸) | âœ… (API ì œê³µ) | âœ… (API ì œê³µ) |
| í˜ì´ì§€ë„¤ì´ì…˜ | âœ… (Sitemap Index) | âœ… (pageToken) | âœ… (cursor) |
| AI ìš”ì•½ í˜¸í™˜ | âœ… | âœ… | âœ… |
| ì—ëŸ¬ í•¸ë“¤ë§ | âœ… (XML íŒŒì‹± ì‹¤íŒ¨) | âœ… (API í‚¤ ì—†ìŒ) | âœ… (ì¿¼ë¦¬ ì—ëŸ¬) |

---

## 7. ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘

| ë¦¬ìŠ¤í¬ | ì˜í–¥ | ëŒ€ì‘ |
|--------|------|------|
| YouTube API í‚¤ ë¯¸ì„¤ì • | YOUTUBE í¬ë¡¤ë§ ì „ë©´ ì‹¤íŒ¨ | ì—ëŸ¬ ë©”ì‹œì§€ + ì†ŒìŠ¤ ìƒíƒœì— ê²½ê³  í‘œì‹œ |
| YouTube API ì¿¼í„° ì´ˆê³¼ | ë‹¹ì¼ í¬ë¡¤ë§ ì¤‘ë‹¨ | ì¿¼í„° ì‚¬ìš©ëŸ‰ ë¡œê¹…, ì´ˆê³¼ ì‹œ ë‹¤ìŒ ë‚  ì¬ì‹œë„ |
| Sitemapì´ ì—†ëŠ” ì‚¬ì´íŠ¸ | ìë™ ê°ì§€ì—ì„œ SITEMAP ì„ íƒ í›„ ì‹¤íŒ¨ | confidenceë¥¼ 0.85ë¡œ ì„¤ì •, ì‹¤íŒ¨ ì‹œ STATIC fallback |
| GraphQL ìŠ¤í‚¤ë§ˆ ë³€ê²½ | íŠ¹ì • í”Œë«í¼ í¬ë¡¤ë§ ì‹¤íŒ¨ | config ì—…ë°ì´íŠ¸ë¡œ ëŒ€ì‘ (ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”) |
| GraphQL config ì„¤ì • ë³µì¡ | ì‚¬ìš©ì ì§„ì…ì¥ë²½ | í”„ë¦¬ì…‹ìœ¼ë¡œ í•´ê²° (Velog, Hashnode ì›í´ë¦­) |
| Vercel Serverless ì œí•œ | YouTube API í˜¸ì¶œ ì‹œê°„ ì´ˆê³¼ | fetchWithTimeout 15ì´ˆ, ì „ì²´ 300ì´ˆ ë‚´ ê´€ë¦¬ |
